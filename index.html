<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshy Review 智能数据助手 (GBK/UTF-8 切换版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; rounded: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 配置常量 ---
        const CATEGORIES = [
            "3d-printing", "game-development", "education", "product-design", 
            "interior-design", "film-production", "e-commerce", "vr-ar", 
            "software", "news", "Others"
        ];

        const KEYWORD_RULES = {
            "3d-printing": ["print", "stl", "miniature", "figure", "tabletop", "warhammer", "resin", "fdm", "slicer", "打印", "模型"],
            "game-development": ["game", "unity", "unreal", "asset", "npc", "character", "roblox", "minecraft", "mod", "gamedev", "play", "游戏", "开发"],
            "vr-ar": ["vr", "ar", "xr", "vision pro", "quest", "virtual reality", "augmented", "metaverse", "虚拟现实"],
            "education": ["student", "teacher", "class", "school", "learn", "study", "project", "university", "education", "教育", "学生"],
            "product-design": ["prototype", "industrial", "product", "mockup", "concept", "design", "cad", "产品", "设计"],
            "interior-design": ["interior", "furniture", "room", "house", "decor", "architect", "室内", "建筑", "装修"],
            "film-production": ["film", "movie", "vfx", "animation", "video", "cinematic", "blender", "maya", "cinema", "影视", "动画"],
            "e-commerce": ["shop", "store", "sell", "marketing", "display", "listing", "amazon", "shopify", "电商", "展示"],
            "software": ["app", "developer", "coding", "software", "integration", "api", "tool", "软件"],
            "news": ["article", "blog", "journalism", "report", "news", "media", "新闻", "媒体"]
        };

        const TARGET_HEADERS = [
            "Review Link", "Meshy Account", "Submitted At Date", "Like Content", 
            "Like", "Dislike Content", "Dislile", "Benefits Content", "Benefits", 
            "Star Rating", "Meets Requirements", "Ease of Use", "Ease of Setup", 
            "Quality of Support", "Industry", "Used For", "Company Size", "Country"
        ];

        // --- 模态框组件 ---
        const Modal = ({ isOpen, onClose, title, children, isLoading }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-fadeIn">
                        <div className="flex justify-between items-center p-6 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                {title}
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 relative">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center h-64 space-y-4">
                                    <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                                    <p className="text-blue-600 font-medium animate-pulse">Gemini 正在思考中...</p>
                                </div>
                            ) : (
                                children
                            )}
                        </div>
                        <div className="p-4 border-t border-gray-100 flex justify-end bg-gray-50 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主应用组件 ---
        function App() {
            const [rawFile, setRawFile] = useState(null); // 存储原始文件对象
            const [data, setData] = useState([]);
            const [processedData, setProcessedData] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [apiKey, setApiKey] = useState("");
            const [useAI, setUseAI] = useState(false);
            const [statusMsg, setStatusMsg] = useState("");
            
            // 编码设置 (解决乱码的关键)
            const [encoding, setEncoding] = useState("utf-8");

            // 新功能状态
            const [reportModalOpen, setReportModalOpen] = useState(false);
            const [replyModalOpen, setReplyModalOpen] = useState(false);
            const [reportContent, setReportContent] = useState("");
            const [replyContent, setReplyContent] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [activeRow, setActiveRow] = useState(null);

            // 当文件或编码改变时，重新读取文件
            useEffect(() => {
                if (rawFile) {
                    readFile(rawFile, encoding);
                }
            }, [rawFile, encoding]);

            const handleFileUpload = (e) => {
                const uploadedFile = e.target.files[0];
                if (!uploadedFile) return;
                setRawFile(uploadedFile); // 触发 useEffect
            };

            const readFile = (file, currentEncoding) => {
                setStatusMsg(`正在以 ${currentEncoding} 编码读取文件...`);
                const reader = new FileReader();
                
                reader.onload = (evt) => {
                    try {
                        const buffer = evt.target.result;
                        let wb;

                        // 策略：如果文件是 CSV，手动使用 TextDecoder 解码
                        // 这解决了 SheetJS 在某些环境下猜不准 GBK CSV 的问题
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            const decoder = new TextDecoder(currentEncoding);
                            const text = decoder.decode(buffer);
                            wb = XLSX.read(text, { type: 'string', cellDates: true });
                        } else {
                            // 对于 .xlsx, .xls，直接用二进制读取，通常不存在编码问题
                            wb = XLSX.read(buffer, { type: 'array', cellDates: true });
                        }

                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const jsonData = XLSX.utils.sheet_to_json(ws);
                        setData(jsonData);
                        setStatusMsg(`成功读取 ${jsonData.length} 条数据。如果文字乱码，请尝试切换上方编码选项。`);
                    } catch (err) {
                        console.error(err);
                        setStatusMsg(`读取失败: ${err.message}。请尝试切换编码。`);
                        setData([]);
                    }
                };

                reader.readAsArrayBuffer(file);
            };

            const formatDate = (val) => {
                if (!val) return "";
                if (val instanceof Date) {
                    const year = val.getFullYear();
                    const month = String(val.getMonth() + 1).padStart(2, '0');
                    const day = String(val.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                if (typeof val === 'number') {
                    const date = new Date((val - 25569) * 86400 * 1000);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return String(val).trim();
            };

            // --- 核心逻辑: 分类分析 ---
            const analyzeLocally = (text) => {
                if (!text) return "Others";
                const lowerText = text.toLowerCase();
                let maxScore = 0;
                let bestCategory = "Others";
                for (const [category, keywords] of Object.entries(KEYWORD_RULES)) {
                    let score = 0;
                    keywords.forEach(kw => { if (lowerText.includes(kw)) score++; });
                    if (score > maxScore) { maxScore = score; bestCategory = category; }
                }
                return bestCategory;
            };

            const analyzeWithGemini = async (text) => {
                const prompt = `Analyze the following user review content related to a 3D AI generator tool. Determine strictly which ONE of the following categories the user belongs to: [${CATEGORIES.join(", ")}]. Review: "${text}". Return ONLY the category name.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const category = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    return CATEGORIES.find(c => c.toLowerCase() === category?.toLowerCase()) || "Others";
                } catch (error) {
                    console.error("API Error:", error);
                    return analyzeLocally(text);
                }
            };

            const processData = async () => {
                if (data.length === 0) return;
                setIsProcessing(true);
                setProcessedData([]);
                const tempResults = [];

                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    setProgress(Math.round(((i + 1) / data.length) * 100));
                    
                    const likeContent = row["What do you like best?"] || "";
                    const dislikeContent = row["What do you dislike"] || "";
                    const benefitsContent = row["Business problems solved/Benefits realized"] || "";
                    const fullText = `${likeContent} ${dislikeContent} ${benefitsContent}`;

                    let usedFor = "Others";
                    if (useAI && apiKey) {
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 500));
                        usedFor = await analyzeWithGemini(fullText);
                    } else {
                        usedFor = analyzeLocally(fullText);
                    }

                    const newRow = {
                        "Review Link": row["Review Link"] || "",
                        "Meshy Account": row["User Email"] || "",
                        "Submitted At Date": formatDate(row["Submitted At Date"]),
                        "Like Content": likeContent,
                        "Like": "",
                        "Dislike Content": dislikeContent,
                        "Dislile": "",
                        "Benefits Content": benefitsContent,
                        "Benefits": "",
                        "Star Rating": row["Star Rating"] || "",
                        "Meets Requirements": row["Meets Requirements"] || "",
                        "Ease of Use": row["Ease of Use"] || "",
                        "Ease of Setup": row["Ease of Setup"] || "",
                        "Quality of Support": row["Quality of Support"] || "",
                        "Industry": row["Industry"] || "",
                        "Used For": usedFor,
                        "Company Size": row["Company Size"] || "",
                        "Country": row["Country"] || ""
                    };
                    tempResults.push(newRow);
                    if (i % 10 === 0 || i === data.length - 1) setProcessedData([...tempResults]);
                }
                setProcessedData(tempResults);
                setIsProcessing(false);
                setStatusMsg("处理完成！");
            };

            const exportExcel = () => {
                const ws = XLSX.utils.json_to_sheet(processedData);
                const wscols = TARGET_HEADERS.map(() => ({ wch: 20 }));
                ws['!cols'] = wscols;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Processed Data");
                XLSX.writeFile(wb, "G2_Review_Processed_Data.xlsx");
            };

            const handleGenerateReport = async () => {
                if (!apiKey) { alert("请先在上方输入 Gemini API Key"); return; }
                setReportModalOpen(true);
                setIsGenerating(true);
                setReportContent("");

                const categoryCounts = {};
                processedData.forEach(r => { categoryCounts[r["Used For"]] = (categoryCounts[r["Used For"]] || 0) + 1; });
                
                const ratings = processedData.map(r => parseFloat(r["Star Rating"]) || 0).filter(r => r > 0);
                const avgRating = (ratings.reduce((a, b) => a + b, 0) / (ratings.length || 1)).toFixed(2);
                
                const samples = processedData
                    .filter(r => r["Like Content"]?.length > 10 || r["Dislike Content"]?.length > 10)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 15)
                    .map(r => `- Role: ${r["Used For"]}, Rating: ${r["Star Rating"]}\n  Like: ${r["Like Content"]}\n  Dislike: ${r["Dislike Content"]}`)
                    .join("\n\n");

                const prompt = `
                    You are a Senior Product Data Analyst. Based on the provided dataset summary of a 3D AI tool "Meshy", write a comprehensive insight report for the Product Manager.
                    
                    **Dataset Stats:**
                    - Total Reviews: ${processedData.length}
                    - Average Rating: ${avgRating}/5.0
                    - Category Distribution: ${JSON.stringify(categoryCounts)}
                    
                    **Review Samples (Random 15):**
                    ${samples}
                    
                    **Please generate a report in Chinese (Markdown format) covering:**
                    1. **用户画像分析 (User Persona)**: Who are the main users?
                    2. **核心优势 (Key Strengths)**: What do users love most?
                    3. **主要痛点 (Critical Pain Points)**: What are the biggest complaints?
                    4. **战略建议 (Strategic Recommendations)**: 3 actionable steps for the next quarter.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    setReportContent(text || "生成失败，请检查 API Key 或重试。");
                } catch (error) {
                    setReportContent("网络错误: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleGenerateReply = async (row) => {
                if (!apiKey) { alert("请先在上方输入 Gemini API Key"); return; }
                setActiveRow(row);
                setReplyModalOpen(true);
                setIsGenerating(true);
                setReplyContent("");

                const prompt = `
                    You are a Customer Success Manager for "Meshy". Draft a polite, helpful, and professional email reply to this user review.
                    **User Review:** Name: ${row["Meshy Account"]}, Rating: ${row["Star Rating"]}/5, Likes: "${row["Like Content"]}", Dislikes: "${row["Dislike Content"]}"
                    Guidelines: Warm, professional, innovative. Language: English (or match user language).
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    setReplyContent(text || "生成失败。");
                } catch (error) {
                    setReplyContent("网络错误: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 p-8">
                    <div className="max-w-7xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-700 to-indigo-800 p-8 text-white relative overflow-hidden">
                            <div className="relative z-10">
                                <h1 className="text-3xl font-bold flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                    Meshy Review 智能数据助手
                                </h1>
                                <p className="opacity-90 mt-2 text-blue-100 max-w-2xl">
                                    集数据清洗、分类映射、Gemini 深度洞察于一体的一站式工具。
                                </p>
                            </div>
                            <div className="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-blue-500 rounded-full opacity-20 blur-3xl"></div>
                        </div>

                        <div className="p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 border-b border-gray-100">
                            {/* Step 1: Upload & Encoding */}
                            <div className="space-y-4">
                                <div className="flex items-center justify-between gap-2 mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 1</span>
                                        <h2 className="font-semibold text-gray-700">上传原始数据</h2>
                                    </div>
                                    
                                </div>
                                
                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition relative group cursor-pointer">
                                    <input type="file" accept=".xlsx, .csv, .xls" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                    <div className="flex flex-col items-center pointer-events-none group-hover:scale-105 transition-transform">
                                        <svg className="w-10 h-10 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                        <span className="text-sm font-medium text-gray-600">{rawFile ? rawFile.name : "点击或拖拽上传 Excel/CSV"}</span>
                                    </div>
                                </div>

                                {/* Encoding Selector - Always visible but mostly used for CSV */}
                                {rawFile && rawFile.name.toLowerCase().endsWith('.csv') && (
                                    <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg flex items-center justify-between text-sm">
                                        <span className="text-yellow-800 font-medium flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                            如果是乱码，请切换:
                                        </span>
                                        <select 
                                            value={encoding} 
                                            onChange={(e) => setEncoding(e.target.value)}
                                            className="border border-gray-300 rounded px-2 py-1 text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none"
                                        >
                                            <option value="utf-8">UTF-8 (默认)</option>
                                            <option value="gbk">中文 (GBK)</option>
                                            <option value="gb18030">中文 (GB18030)</option>
                                            <option value="big5">繁体 (Big5)</option>
                                        </select>
                                    </div>
                                )}
                            </div>

                            {/* Step 2: Settings */}
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 2</span>
                                    <h2 className="font-semibold text-gray-700">AI 设置 (推荐)</h2>
                                </div>
                                <div className="bg-gray-50 p-5 rounded-lg border border-gray-200 h-full flex flex-col justify-center space-y-4">
                                    <label className="flex items-center space-x-3 cursor-pointer select-none">
                                        <input type="checkbox" checked={useAI} onChange={(e) => setUseAI(e.target.checked)} className="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" />
                                        <span className="text-gray-700 font-medium">启用 Gemini AI 增强功能 ✨</span>
                                    </label>
                                    
                                    {useAI ? (
                                        <div className="animate-fadeIn space-y-2">
                                            <input type="password" placeholder="输入 Gemini API Key (以AI开头)" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
                                            <p className="text-xs text-gray-500">
                                                * 用于智能分类、生成报告和回复助手。
                                            </p>
                                        </div>
                                    ) : (
                                        <p className="text-xs text-gray-500 bg-white p-2 rounded border border-gray-200">
                                            当前使用本地关键词匹配。启用 AI 可解锁深度洞察和智能回复功能。
                                        </p>
                                    )}
                                </div>
                            </div>

                            {/* Step 3: Action */}
                            <div className="space-y-4 flex flex-col justify-between">
                                <div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 3</span>
                                        <h2 className="font-semibold text-gray-700">执行处理</h2>
                                    </div>
                                    <button onClick={processData} disabled={!rawFile || isProcessing} className={`w-full py-4 rounded-lg font-bold text-white shadow-lg transform transition active:scale-95 ${!rawFile || isProcessing ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:shadow-xl'}`}>
                                        {isProcessing ? (
                                            <span className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> 处理中...</span>
                                        ) : '开始清洗数据'}
                                    </button>
                                </div>
                                
                                {processedData.length > 0 && useAI && (
                                    <button onClick={handleGenerateReport} className="w-full py-3 bg-white border-2 border-indigo-100 text-indigo-700 font-bold rounded-lg hover:bg-indigo-50 transition flex items-center justify-center gap-2 shadow-sm">
                                        <span className="text-lg">✨</span> 生成全库深度洞察报告
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Progress Bar */}
                        {isProcessing && (
                            <div className="w-full bg-gray-100 h-1">
                                <div className="bg-blue-600 h-1 transition-all duration-300 shadow-[0_0_10px_rgba(37,99,235,0.5)]" style={{width: `${progress}%`}}></div>
                            </div>
                        )}

                        {/* Preview Section */}
                        <div className="p-8 bg-gray-50/50">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-4">
                                    <h2 className="text-xl font-bold text-gray-800">结果预览</h2>
                                    {processedData.length > 0 && <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">{processedData.length} 条数据</span>}
                                    {statusMsg && <span className="text-xs text-gray-500 max-w-md truncate" title={statusMsg}>{statusMsg}</span>}
                                </div>
                                {processedData.length > 0 && (
                                    <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg flex items-center gap-2 font-bold shadow-md hover:shadow-lg transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                        下载 Excel 结果
                                    </button>
                                )}
                            </div>

                            <div className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col max-h-[600px]">
                                <div className="overflow-auto custom-scrollbar">
                                    <table className="min-w-full text-sm divide-y divide-gray-100">
                                        <thead className="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="px-4 py-3 text-left font-bold text-gray-500 uppercase tracking-wider bg-gray-50 w-24 sticky left-0 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                    操作 ✨
                                                </th>
                                                {TARGET_HEADERS.map(header => (
                                                    <th key={header} className="px-4 py-3 text-left font-bold text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                                        {header}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {processedData.length === 0 ? (
                                                <tr>
                                                    <td colSpan={TARGET_HEADERS.length + 1} className="px-6 py-20 text-center">
                                                        <div className="flex flex-col items-center justify-center text-gray-400">
                                                            <svg className="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd"></path></svg>
                                                            <p>请上传文件并开始处理</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ) : (
                                                processedData.map((row, idx) => (
                                                    <tr key={idx} className="hover:bg-blue-50/50 transition group">
                                                        <td className="px-4 py-2 sticky left-0 bg-white group-hover:bg-blue-50/50 z-10 border-r border-gray-100">
                                                            <button 
                                                                onClick={() => handleGenerateReply(row)}
                                                                disabled={!useAI}
                                                                className={`text-xs px-2 py-1 rounded border transition flex items-center gap-1
                                                                    ${useAI ? 'bg-indigo-50 text-indigo-600 border-indigo-200 hover:bg-indigo-100 hover:border-indigo-300' : 'bg-gray-50 text-gray-400 cursor-not-allowed'}
                                                                `}
                                                                title={useAI ? "生成回复草稿" : "请先开启 AI 功能"}
                                                            >
                                                                ✨ 回复
                                                            </button>
                                                        </td>
                                                        {TARGET_HEADERS.map(header => (
                                                            <td key={`${idx}-${header}`} className="px-4 py-3 whitespace-nowrap text-gray-600 truncate max-w-[200px]" title={row[header]}>
                                                                {header === "Used For" ? (
                                                                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border
                                                                        ${row[header] === 'Others' ? 'bg-gray-100 text-gray-600 border-gray-200' : 'bg-blue-50 text-blue-700 border-blue-100'}`}>
                                                                        {row[header]}
                                                                    </span>
                                                                ) : (
                                                                    row[header]
                                                                )}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Report Modal */}
                    <Modal isOpen={reportModalOpen} onClose={() => setReportModalOpen(false)} title="✨ 全库深度洞察报告 (Deep Insight Report)" isLoading={isGenerating}>
                        <div className="prose prose-blue max-w-none report-content whitespace-pre-wrap text-gray-700">
                            {reportContent}
                        </div>
                    </Modal>

                    {/* Reply Modal */}
                    <Modal isOpen={replyModalOpen} onClose={() => setReplyModalOpen(false)} title={`✨ 智能回复草稿 - ${activeRow?.["Meshy Account"]}`} isLoading={isGenerating}>
                        <div className="space-y-4">
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-600">
                                <p><strong>用户评论:</strong> {activeRow?.["Like Content"]} {activeRow?.["Dislike Content"]}</p>
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-gray-700">建议回复内容 (可直接复制):</label>
                                <textarea 
                                    readOnly 
                                    className="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-800 font-mono text-sm bg-white"
                                    value={replyContent}
                                ></textarea>
                            </div>
                            <div className="flex justify-end">
                                <button 
                                    onClick={() => { navigator.clipboard.writeText(replyContent); alert("已复制到剪贴板"); }}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition"
                                >
                                    复制内容
                                </button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
