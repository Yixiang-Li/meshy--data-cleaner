<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshy Review 智能数据助手 (自动过滤被拒版 v7)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; rounded: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 配置常量 ---
        const CATEGORIES = [
            "3d-printing", "game-development", "education", "product-design", 
            "interior-design", "film-production", "e-commerce", "vr-ar", 
            "software", "news", "Others"
        ];

        const KEYWORD_RULES = {
            "3d-printing": ["print", "stl", "miniature", "figure", "tabletop", "warhammer", "resin", "fdm", "slicer", "打印", "模型"],
            "game-development": ["game", "unity", "unreal", "asset", "npc", "character", "roblox", "minecraft", "mod", "gamedev", "play", "游戏", "开发"],
            "vr-ar": ["vr", "ar", "xr", "vision pro", "quest", "virtual reality", "augmented", "metaverse", "虚拟现实"],
            "education": ["student", "teacher", "class", "school", "learn", "study", "project", "university", "education", "教育", "学生"],
            "product-design": ["prototype", "industrial", "product", "mockup", "concept", "design", "cad", "产品", "设计"],
            "interior-design": ["interior", "furniture", "room", "house", "decor", "architect", "室内", "建筑", "装修"],
            "film-production": ["film", "movie", "vfx", "animation", "video", "cinematic", "blender", "maya", "cinema", "影视", "动画"],
            "e-commerce": ["shop", "store", "sell", "marketing", "display", "listing", "amazon", "shopify", "电商", "展示"],
            "software": ["app", "developer", "coding", "software", "integration", "api", "tool", "软件"],
            "news": ["article", "blog", "journalism", "report", "news", "media", "新闻", "媒体"]
        };

        const TARGET_HEADERS = [
            "Review Link", "Meshy Account", "Submitted At Date", "Like Content", 
            "Like", "Dislike Content", "Dislile", "Benefits Content", "Benefits", 
            "Star Rating", "Meets Requirements", "Ease of Use", "Ease of Setup", 
            "Quality of Support", "Industry", "Used For", "Company Size", "Country"
        ];

        // --- 模态框组件 ---
        const Modal = ({ isOpen, onClose, title, children, isLoading }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 animate-fadeIn">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100">
                        <div className="flex justify-between items-center p-6 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                {title}
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 relative">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center h-64 space-y-4">
                                    <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                                    <p className="text-blue-600 font-medium animate-pulse">Gemini 正在思考中...</p>
                                </div>
                            ) : (
                                children
                            )}
                        </div>
                        <div className="p-4 border-t border-gray-100 flex justify-end bg-gray-50 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主应用组件 ---
        function App() {
            // 文件状态
            const [rawFile, setRawFile] = useState(null); 
            const [historyFile, setHistoryFile] = useState(null); 
            
            // 数据状态
            const [data, setData] = useState([]); 
            const [historyIds, setHistoryIds] = useState(new Set()); 
            
            const [processedData, setProcessedData] = useState([]); 
            const [deltaData, setDeltaData] = useState([]); 
            
            // UI 状态
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [apiKey, setApiKey] = useState(localStorage.getItem("meshy_gemini_key") || "");
            const [useAI, setUseAI] = useState(false);
            const [statusMsg, setStatusMsg] = useState("");
            const [encoding, setEncoding] = useState("utf-8");
            const [viewMode, setViewMode] = useState("all"); 

            // AI 功能状态
            const [reportModalOpen, setReportModalOpen] = useState(false);
            const [replyModalOpen, setReplyModalOpen] = useState(false);
            const [reportContent, setReportContent] = useState("");
            const [replyContent, setReplyContent] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [activeRow, setActiveRow] = useState(null);

            // 保存 Key 到本地
            useEffect(() => {
                if (apiKey) localStorage.setItem("meshy_gemini_key", apiKey);
            }, [apiKey]);

            // 通用文件读取函数
            const readFile = (file, callback) => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const buffer = evt.target.result;
                        let wb;
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            const decoder = new TextDecoder(encoding); 
                            const text = decoder.decode(buffer);
                            wb = XLSX.read(text, { type: 'string', cellDates: true });
                        } else {
                            wb = XLSX.read(buffer, { type: 'array', cellDates: true });
                        }
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const jsonData = XLSX.utils.sheet_to_json(ws);
                        callback(jsonData);
                    } catch (err) {
                        console.error(err);
                        setStatusMsg(`读取文件 ${file.name} 失败: ${err.message}`);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleRawFileUpload = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setRawFile(f);
                setStatusMsg(`正在读取新文件: ${f.name}...`);
                readFile(f, (jsonData) => {
                    setData(jsonData);
                    setStatusMsg(`新文件读取成功: ${jsonData.length} 行。`);
                });
            };

            const handleHistoryFileUpload = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setHistoryFile(f);
                setStatusMsg(`正在读取历史文件: ${f.name}...`);
                readFile(f, (jsonData) => {
                    const ids = new Set();
                    let idCount = 0;
                    jsonData.forEach(row => {
                        const link = row["Review Link"] || row["ReviewLink"] || "";
                        if (link) {
                            ids.add(link.toString().trim());
                            idCount++;
                        }
                    });
                    setHistoryIds(ids);
                    setStatusMsg(`历史文件读取成功，包含 ${idCount} 个唯一 Review Link。`);
                });
            };

            const formatDate = (val) => {
                if (!val) return "";
                if (val instanceof Date) {
                    const year = val.getFullYear();
                    const month = String(val.getMonth() + 1).padStart(2, '0');
                    const day = String(val.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                if (typeof val === 'number') {
                    const date = new Date((val - 25569) * 86400 * 1000);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return String(val).trim();
            };

            const analyzeLocally = (text) => {
                if (!text) return "Others";
                const lowerText = text.toLowerCase();
                let maxScore = 0;
                let bestCategory = "Others";
                for (const [category, keywords] of Object.entries(KEYWORD_RULES)) {
                    let score = 0;
                    keywords.forEach(kw => { if (lowerText.includes(kw)) score++; });
                    if (score > maxScore) { maxScore = score; bestCategory = category; }
                }
                return bestCategory;
            };

            const analyzeWithGemini = async (text) => {
                const prompt = `Analyze the following user review content related to a 3D AI generator tool. Determine strictly which ONE of the following categories the user belongs to: [${CATEGORIES.join(", ")}]. Review: "${text}". Return ONLY the category name.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const category = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    return CATEGORIES.find(c => c.toLowerCase() === category?.toLowerCase()) || "Others";
                } catch (error) {
                    console.error("API Error:", error);
                    return analyzeLocally(text);
                }
            };

            const processData = async () => {
                if (data.length === 0) return;
                setIsProcessing(true);
                setProcessedData([]);
                setDeltaData([]);
                const tempResults = [];
                const tempDelta = [];
                let rejectedCount = 0; // 计数被拒的条目

                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    setProgress(Math.round(((i + 1) / data.length) * 100));

                    // --- 核心更新：检测 Manual Rejection Reasons 列 ---
                    const rejectionReason = row["Manual Rejection Reasons"];
                    if (rejectionReason && rejectionReason.toString().trim() !== "") {
                        // 如果这一列有内容，说明是被 Reject 的，直接跳过
                        rejectedCount++;
                        continue; 
                    }
                    // ----------------------------------------------
                    
                    const likeContent = row["What do you like best?"] || "";
                    const dislikeContent = row["What do you dislike"] || "";
                    const benefitsContent = row["Business problems solved/Benefits realized"] || "";
                    const fullText = `${likeContent} ${dislikeContent} ${benefitsContent}`;

                    let usedFor = "Others";
                    if (useAI && apiKey) {
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 500));
                        usedFor = await analyzeWithGemini(fullText);
                    } else {
                        usedFor = analyzeLocally(fullText);
                    }

                    const reviewLink = (row["Review Link"] || "").toString().trim();

                    const newRow = {
                        "Review Link": reviewLink,
                        "Meshy Account": row["User Email"] || "",
                        "Submitted At Date": formatDate(row["Submitted At Date"]),
                        "Like Content": likeContent,
                        "Like": "",
                        "Dislike Content": dislikeContent,
                        "Dislile": "",
                        "Benefits Content": benefitsContent,
                        "Benefits": "",
                        "Star Rating": row["Star Rating"] || "",
                        "Meets Requirements": row["Meets Requirements"] || "",
                        "Ease of Use": row["Ease of Use"] || "",
                        "Ease of Setup": row["Ease of Setup"] || "",
                        "Quality of Support": row["Quality of Support"] || "",
                        "Industry": row["Industry"] || "",
                        "Used For": usedFor,
                        "Company Size": row["Company Size"] || "",
                        "Country": row["Country"] || ""
                    };
                    
                    tempResults.push(newRow);

                    if (!historyIds.has(reviewLink)) {
                        tempDelta.push(newRow);
                    }

                    if (i % 10 === 0 || i === data.length - 1) {
                        setProcessedData([...tempResults]);
                        setDeltaData([...tempDelta]);
                    }
                }

                setProcessedData(tempResults);
                setDeltaData(tempDelta);
                setIsProcessing(false);
                
                let finalMsg = "";
                if (historyFile && tempDelta.length > 0) {
                    setViewMode("delta");
                    finalMsg = `处理完成！新增 ${tempDelta.length} 条数据。`;
                } else {
                    setViewMode("all");
                    finalMsg = `处理完成！共 ${tempResults.length} 条有效数据。`;
                }
                
                // 添加过滤信息
                if (rejectedCount > 0) {
                    finalMsg += ` (已自动过滤 ${rejectedCount} 条被拒数据)`;
                }
                setStatusMsg(finalMsg);
            };

            const exportExcel = (dataToExport, fileName) => {
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wscols = TARGET_HEADERS.map(() => ({ wch: 20 }));
                ws['!cols'] = wscols;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Processed Data");
                XLSX.writeFile(wb, fileName);
            };

            const handleGenerateReport = async () => {
                if (!apiKey) { alert("请先在上方输入 Gemini API Key"); return; }
                setReportModalOpen(true);
                setIsGenerating(true);
                setReportContent("");

                const targetData = viewMode === "delta" ? deltaData : processedData;
                
                if (targetData.length === 0) {
                    setReportContent("当前列表没有数据，无法生成报告。");
                    setIsGenerating(false);
                    return;
                }

                const categoryCounts = {};
                targetData.forEach(r => { categoryCounts[r["Used For"]] = (categoryCounts[r["Used For"]] || 0) + 1; });
                
                const ratings = targetData.map(r => parseFloat(r["Star Rating"]) || 0).filter(r => r > 0);
                const avgRating = (ratings.reduce((a, b) => a + b, 0) / (ratings.length || 1)).toFixed(2);
                
                const samples = targetData
                    .filter(r => r["Like Content"]?.length > 10 || r["Dislike Content"]?.length > 10)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 15)
                    .map(r => `- Role: ${r["Used For"]}, Rating: ${r["Star Rating"]}\n  Like: ${r["Like Content"]}\n  Dislike: ${r["Dislike Content"]}`)
                    .join("\n\n");

                const prompt = `
                    You are a Senior Product Data Analyst. Based on the provided dataset summary of a 3D AI tool "Meshy", write a comprehensive insight report for the Product Manager.
                    
                    **Dataset Context:**
                    - Scope: ${viewMode === 'delta' ? 'New Reviews Only (Incremental Update)' : 'All Reviews (Full Dataset)'}
                    - Total Reviews: ${targetData.length}
                    - Average Rating: ${avgRating}/5.0
                    - Category Distribution: ${JSON.stringify(categoryCounts)}
                    
                    **Review Samples (Random 15):**
                    ${samples}
                    
                    **Please generate a report in Chinese (Markdown format) covering:**
                    1. **Overview**: Brief summary of this batch.
                    2. **User Persona**: Who are these users?
                    3. **Key Strengths**: What do they love?
                    4. **Pain Points**: Major complaints.
                    5. **Actionable Suggestions**: 3 steps for the product team.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    setReportContent(text || "生成失败，请检查 API Key 或重试。");
                } catch (error) {
                    setReportContent("网络错误: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleGenerateReply = async (row) => {
                if (!apiKey) { alert("请先在上方输入 Gemini API Key"); return; }
                setActiveRow(row);
                setReplyModalOpen(true);
                setIsGenerating(true);
                setReplyContent("");

                const prompt = `
                    You are a Customer Success Manager for "Meshy". Draft a polite, helpful, and professional email reply to this user review.
                    **User Review:** Name: ${row["Meshy Account"]}, Rating: ${row["Star Rating"]}/5, Likes: "${row["Like Content"]}", Dislikes: "${row["Dislike Content"]}"
                    Guidelines: Warm, professional, innovative. Language: English (or match user language).
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    setReplyContent(text || "生成失败。");
                } catch (error) {
                    setReplyContent("网络错误: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 p-8">
                    <div className="max-w-7xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-700 to-indigo-800 p-8 text-white relative overflow-hidden">
                            <div className="relative z-10">
                                <h1 className="text-3xl font-bold flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                    Meshy Review 智能数据助手 <span className="text-sm bg-blue-600 px-2 py-1 rounded-full border border-blue-400">v7 过滤版</span>
                                </h1>
                                <p className="opacity-90 mt-2 text-blue-100 max-w-2xl">
                                    支持历史数据对比，自动过滤 Rejected 评论。
                                </p>
                            </div>
                            <div className="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-blue-500 rounded-full opacity-20 blur-3xl"></div>
                        </div>

                        <div className="p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 border-b border-gray-100">
                            {/* Step 1: Upload */}
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 1</span>
                                    <h2 className="font-semibold text-gray-700">数据上传</h2>
                                </div>
                                
                                {/* 历史数据上传 */}
                                <div className="bg-orange-50 border border-orange-100 rounded-lg p-3">
                                    <label className="block text-xs font-bold text-orange-700 mb-1 uppercase">A. 历史已清洗数据 (可选)</label>
                                    <input type="file" accept=".xlsx, .csv, .xls" onChange={handleHistoryFileUpload} className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-orange-100 file:text-orange-700 hover:file:bg-orange-200"/>
                                    <p className="text-xs text-orange-600/80 mt-1">上传后将开启增量去重功能。</p>
                                </div>

                                {/* 新数据上传 */}
                                <div className="bg-blue-50 border border-blue-100 rounded-lg p-3">
                                    <label className="block text-xs font-bold text-blue-700 mb-1 uppercase">B. 本周新原始数据 (必选)</label>
                                    <input type="file" accept=".xlsx, .csv, .xls" onChange={handleRawFileUpload} className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"/>
                                    {rawFile && rawFile.name.toLowerCase().endsWith('.csv') && (
                                        <div className="mt-2 flex items-center justify-between text-xs">
                                            <span className="text-gray-500">编码修正:</span>
                                            <select value={encoding} onChange={(e) => setEncoding(e.target.value)} className="border border-gray-300 rounded px-1 py-0.5 bg-white">
                                                <option value="utf-8">UTF-8</option>
                                                <option value="gbk">GBK (中文)</option>
                                            </select>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Step 2: Settings */}
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 2</span>
                                    <h2 className="font-semibold text-gray-700">AI 设置</h2>
                                </div>
                                <div className="bg-gray-50 p-5 rounded-lg border border-gray-200 h-full flex flex-col justify-center space-y-4">
                                    <label className="flex items-center space-x-3 cursor-pointer select-none">
                                        <input type="checkbox" checked={useAI} onChange={(e) => setUseAI(e.target.checked)} className="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" />
                                        <span className="text-gray-700 font-medium">启用 Gemini AI 增强 ✨</span>
                                    </label>
                                    
                                    {useAI ? (
                                        <div className="animate-fadeIn space-y-2">
                                            <input type="password" placeholder="输入 Gemini API Key" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
                                            <p className="text-xs text-gray-500">* Key 会自动保存在浏览器中。</p>
                                        </div>
                                    ) : (
                                        <p className="text-xs text-gray-500 bg-white p-2 rounded border border-gray-200">
                                            未启用 AI 时，将使用本地关键词规则进行分类。
                                        </p>
                                    )}
                                </div>
                            </div>

                            {/* Step 3: Action */}
                            <div className="space-y-4 flex flex-col justify-between">
                                <div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 3</span>
                                        <h2 className="font-semibold text-gray-700">处理</h2>
                                    </div>
                                    <button onClick={processData} disabled={!rawFile || isProcessing} className={`w-full py-4 rounded-lg font-bold text-white shadow-lg transform transition active:scale-95 ${!rawFile || isProcessing ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:shadow-xl'}`}>
                                        {isProcessing ? (
                                            <span className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> 处理中...</span>
                                        ) : '开始清洗与去重'}
                                    </button>
                                </div>
                                
                                {processedData.length > 0 && useAI && (
                                    <button onClick={handleGenerateReport} className="w-full py-3 bg-white border-2 border-indigo-100 text-indigo-700 font-bold rounded-lg hover:bg-indigo-50 transition flex items-center justify-center gap-2 shadow-sm">
                                        <span className="text-lg">✨</span> 
                                        {viewMode === 'delta' ? '生成本周新增数据报告' : '生成全量洞察报告'}
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Progress Bar */}
                        {isProcessing && (
                            <div className="w-full bg-gray-100 h-1">
                                <div className="bg-blue-600 h-1 transition-all duration-300 shadow-[0_0_10px_rgba(37,99,235,0.5)]" style={{width: `${progress}%`}}></div>
                            </div>
                        )}

                        {/* Preview Section */}
                        <div className="p-8 bg-gray-50/50">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-4">
                                    <h2 className="text-xl font-bold text-gray-800">结果预览</h2>
                                    
                                    {/* 视图切换按钮 */}
                                    {processedData.length > 0 && (
                                        <div className="flex bg-gray-200 rounded-lg p-1">
                                            <button 
                                                onClick={() => setViewMode("all")}
                                                className={`px-3 py-1 text-xs font-bold rounded-md transition ${viewMode === 'all' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                            >
                                                全量 ({processedData.length})
                                            </button>
                                            <button 
                                                onClick={() => setViewMode("delta")}
                                                className={`px-3 py-1 text-xs font-bold rounded-md transition flex items-center gap-1 ${viewMode === 'delta' ? 'bg-white shadow text-green-600' : 'text-gray-500 hover:text-gray-700'}`}
                                            >
                                                仅新增 ({deltaData.length})
                                                {deltaData.length > 0 && <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>}
                                            </button>
                                        </div>
                                    )}
                                    
                                    {statusMsg && <span className="text-xs text-gray-500 max-w-xs truncate hidden md:block" title={statusMsg}>{statusMsg}</span>}
                                </div>

                                <div className="flex gap-2">
                                    {deltaData.length > 0 && (
                                        <button 
                                            onClick={() => exportExcel(deltaData, `G2_Reviews_Incremental_New_${deltaData.length}.xlsx`)}
                                            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold shadow-md hover:shadow-lg transition text-sm"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                            下载新增部分 Excel
                                        </button>
                                    )}
                                    
                                    {processedData.length > 0 && (
                                        <button 
                                            onClick={() => exportExcel(processedData, `G2_Reviews_Full_Processed_${processedData.length}.xlsx`)}
                                            className="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg flex items-center gap-2 font-bold shadow-sm hover:shadow transition text-sm"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                            下载全量 Excel
                                        </button>
                                    )}
                                </div>
                            </div>

                            <div className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col max-h-[600px]">
                                <div className="overflow-auto custom-scrollbar">
                                    <table className="min-w-full text-sm divide-y divide-gray-100">
                                        <thead className="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                            <tr>
                                                <th className="px-4 py-3 text-left font-bold text-gray-500 uppercase tracking-wider bg-gray-50 w-24 sticky left-0 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                    操作 ✨
                                                </th>
                                                {TARGET_HEADERS.map(header => (
                                                    <th key={header} className="px-4 py-3 text-left font-bold text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                                        {header}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {(viewMode === 'delta' ? deltaData : processedData).length === 0 ? (
                                                <tr>
                                                    <td colSpan={TARGET_HEADERS.length + 1} className="px-6 py-20 text-center">
                                                        <div className="flex flex-col items-center justify-center text-gray-400">
                                                            <svg className="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd"></path></svg>
                                                            <p>
                                                                {viewMode === 'delta' 
                                                                    ? "没有检测到新增数据 (或者尚未开始处理)" 
                                                                    : "请上传文件并开始处理"}
                                                            </p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ) : (
                                                (viewMode === 'delta' ? deltaData : processedData).map((row, idx) => (
                                                    <tr key={idx} className={`hover:bg-blue-50/50 transition group ${viewMode === 'delta' ? 'bg-green-50/30' : ''}`}>
                                                        <td className="px-4 py-2 sticky left-0 bg-white group-hover:bg-blue-50/50 z-10 border-r border-gray-100">
                                                            <button 
                                                                onClick={() => handleGenerateReply(row)}
                                                                disabled={!useAI}
                                                                className={`text-xs px-2 py-1 rounded border transition flex items-center gap-1
                                                                    ${useAI ? 'bg-indigo-50 text-indigo-600 border-indigo-200 hover:bg-indigo-100 hover:border-indigo-300' : 'bg-gray-50 text-gray-400 cursor-not-allowed'}
                                                                `}
                                                                title={useAI ? "生成回复草稿" : "请先开启 AI 功能"}
                                                            >
                                                                ✨ 回复
                                                            </button>
                                                        </td>
                                                        {TARGET_HEADERS.map(header => (
                                                            <td key={`${idx}-${header}`} className="px-4 py-3 whitespace-nowrap text-gray-600 truncate max-w-[200px]" title={row[header]}>
                                                                {header === "Used For" ? (
                                                                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border
                                                                        ${row[header] === 'Others' ? 'bg-gray-100 text-gray-600 border-gray-200' : 'bg-blue-50 text-blue-700 border-blue-100'}`}>
                                                                        {row[header]}
                                                                    </span>
                                                                ) : (
                                                                    row[header]
                                                                )}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Report Modal */}
                    <Modal isOpen={reportModalOpen} onClose={() => setReportModalOpen(false)} title={`✨ 深度洞察报告 (${viewMode === 'delta' ? '新增部分' : '全量数据'})`} isLoading={isGenerating}>
                        <div className="prose prose-blue max-w-none report-content whitespace-pre-wrap text-gray-700">
                            {reportContent}
                        </div>
                    </Modal>

                    {/* Reply Modal */}
                    <Modal isOpen={replyModalOpen} onClose={() => setReplyModalOpen(false)} title={`✨ 智能回复草稿 - ${activeRow?.["Meshy Account"]}`} isLoading={isGenerating}>
                        <div className="space-y-4">
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-600">
                                <p><strong>用户评论:</strong> {activeRow?.["Like Content"]} {activeRow?.["Dislike Content"]}</p>
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-gray-700">建议回复内容 (可直接复制):</label>
                                <textarea 
                                    readOnly 
                                    className="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-800 font-mono text-sm bg-white"
                                    value={replyContent}
                                ></textarea>
                            </div>
                            <div className="flex justify-end">
                                <button 
                                    onClick={() => { navigator.clipboard.writeText(replyContent); alert("已复制到剪贴板"); }}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition"
                                >
                                    复制内容
                                </button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
